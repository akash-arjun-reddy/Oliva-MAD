# Database Relationship Diagram

## ğŸ” **AUTHENTICATION & SECURITY LAYER**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      users      â”‚    â”‚  refresh_tokens  â”‚    â”‚ enhanced_user_sessions â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚â—„â”€â”€â”€â”¤ user_id (FK)     â”‚    â”‚ id (PK)             â”‚
â”‚ username        â”‚    â”‚ token_hash       â”‚    â”‚ user_id (FK)        â”‚
â”‚ email           â”‚    â”‚ expires_at       â”‚    â”‚ session_id          â”‚
â”‚ hashed_password â”‚    â”‚ device_info      â”‚    â”‚ refresh_token_id(FK)â”‚
â”‚ is_active       â”‚    â”‚ ip_address       â”‚    â”‚ status              â”‚
â”‚ is_customer     â”‚    â”‚ user_agent       â”‚    â”‚ expires_at          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                        â”‚
         â”‚                       â”‚                        â”‚
         â–¼                       â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   audit_logs    â”‚    â”‚ rate_limit_logs  â”‚    â”‚   session_logs      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚    â”‚ id (PK)          â”‚    â”‚ id (PK)             â”‚
â”‚ user_id (FK)    â”‚    â”‚ identifier       â”‚    â”‚ user_id (FK)        â”‚
â”‚ action          â”‚    â”‚ action           â”‚    â”‚ action              â”‚
â”‚ resource        â”‚    â”‚ attempts         â”‚    â”‚ session_token       â”‚
â”‚ ip_address      â”‚    â”‚ blocked_until    â”‚    â”‚ ip_address          â”‚
â”‚ success         â”‚    â”‚ created_at       â”‚    â”‚ success             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ‘¥ **RBAC (ROLE-BASED ACCESS CONTROL) LAYER**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      roles      â”‚    â”‚   permissions    â”‚    â”‚   user_permissions  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚    â”‚ id (PK)          â”‚    â”‚ id (PK)             â”‚
â”‚ name            â”‚    â”‚ name             â”‚    â”‚ user_id (FK)        â”‚
â”‚ description     â”‚    â”‚ resource         â”‚    â”‚ permission_id (FK)  â”‚
â”‚ is_active       â”‚    â”‚ action           â”‚    â”‚ granted_by (FK)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ expires_at          â”‚
         â”‚                       â”‚             â”‚ is_active           â”‚
         â”‚                       â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                        â”‚
         â”‚                       â”‚                        â”‚
         â–¼                       â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    user_roles   â”‚    â”‚ role_permissions â”‚    â”‚      users          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ user_id (FK)    â”‚    â”‚ role_id (FK)     â”‚    â”‚ id (PK)             â”‚
â”‚ role_id (FK)    â”‚    â”‚ permission_id(FK)â”‚    â”‚ username            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ email               â”‚
                                               â”‚ hashed_password     â”‚
                                               â”‚ is_active           â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¥ **BUSINESS LOGIC LAYER**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   appointments  â”‚    â”‚     bookings     â”‚    â”‚     customers       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚    â”‚ id (PK)          â”‚    â”‚ id (PK)             â”‚
â”‚ user_id (FK)    â”‚    â”‚ user_id (FK)     â”‚    â”‚ user_id (FK)        â”‚
â”‚ customer_id(FK) â”‚    â”‚ customer_id (FK) â”‚    â”‚ name                â”‚
â”‚ service_id      â”‚    â”‚ appointment_id(FK)â”‚   â”‚ contact_info        â”‚
â”‚ appointment_dateâ”‚    â”‚ booking_date     â”‚    â”‚ preferences         â”‚
â”‚ status          â”‚    â”‚ status           â”‚    â”‚ loyalty_points      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                        â”‚
         â”‚                       â”‚                        â”‚
         â–¼                       â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     products    â”‚    â”‚payment_transactionsâ”‚  â”‚   order_events      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚    â”‚ id (PK)          â”‚    â”‚ id (PK)             â”‚
â”‚ name            â”‚    â”‚ booking_id (FK)  â”‚    â”‚ order_id            â”‚
â”‚ description     â”‚    â”‚ customer_id (FK) â”‚    â”‚ event_type          â”‚
â”‚ price           â”‚    â”‚ amount           â”‚    â”‚ event_data          â”‚
â”‚ category        â”‚    â”‚ payment_method   â”‚    â”‚ created_at          â”‚
â”‚ is_active       â”‚    â”‚ status           â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ inventory_logs  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚
â”‚ product_id (FK) â”‚
â”‚ action          â”‚
â”‚ quantity        â”‚
â”‚ timestamp       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ **REWARDS & MARKETING LAYER**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     rewards     â”‚    â”‚      offers      â”‚    â”‚  advertisements     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚    â”‚ id (PK)          â”‚    â”‚ id (PK)             â”‚
â”‚ name            â”‚    â”‚ name             â”‚    â”‚ title               â”‚
â”‚ type            â”‚    â”‚ description      â”‚    â”‚ content             â”‚
â”‚ value           â”‚    â”‚ discount_percent â”‚    â”‚ target_audience     â”‚
â”‚ conditions      â”‚    â”‚ valid_from       â”‚    â”‚ is_active           â”‚
â”‚ is_active       â”‚    â”‚ valid_until      â”‚    â”‚ created_at          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                        â”‚
         â”‚                       â”‚                        â”‚
         â–¼                       â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    referrals    â”‚    â”‚   customer_offersâ”‚    â”‚ customer_ads_viewed â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚    â”‚ id (PK)          â”‚    â”‚ id (PK)             â”‚
â”‚ referrer_id(FK) â”‚    â”‚ customer_id (FK) â”‚    â”‚ customer_id (FK)    â”‚
â”‚ referred_id(FK) â”‚    â”‚ offer_id (FK)    â”‚    â”‚ ad_id (FK)          â”‚
â”‚ reward_points   â”‚    â”‚ used_at          â”‚    â”‚ viewed_at           â”‚
â”‚ status          â”‚    â”‚ status           â”‚    â”‚ clicked             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”— **CROSS-LAYER RELATIONSHIPS**

### **User-Centric Flow**
```
users (1) â†â†’ (many) appointments
users (1) â†â†’ (many) bookings  
users (1) â†â†’ (many) customers
users (1) â†â†’ (many) refresh_tokens
users (1) â†â†’ (many) audit_logs
```

### **Security Flow**
```
users (many) â†â†’ (many) roles (via user_roles)
roles (many) â†â†’ (many) permissions (via role_permissions)
users (1) â†â†’ (many) user_permissions
```

### **Business Flow**
```
customers (1) â†â†’ (many) appointments
customers (1) â†â†’ (many) bookings
bookings (1) â†â†’ (many) payment_transactions
products (1) â†â†’ (many) inventory_logs
```

## ğŸ“Š **Data Flow Patterns**

### **Authentication Flow**
```
1. User Login â†’ users table
2. Create Token â†’ refresh_tokens table  
3. Create Session â†’ enhanced_user_sessions table
4. Log Event â†’ audit_logs table
```

### **Authorization Flow**
```
1. Check User Roles â†’ user_roles table
2. Check Role Permissions â†’ role_permissions table
3. Check Direct Permissions â†’ user_permissions table
4. Log Access â†’ audit_logs table
```

### **Business Flow**
```
1. Customer Books â†’ bookings table
2. Create Appointment â†’ appointments table
3. Process Payment â†’ payment_transactions table
4. Track Events â†’ order_events table
5. Update Inventory â†’ inventory_logs table
```

## ğŸ¯ **Key Design Principles**

1. **Separation of Concerns**: Each layer handles specific functionality
2. **Security First**: Authentication and authorization are separate from business logic
3. **Audit Trail**: All important actions are logged for security and compliance
4. **Scalability**: Many-to-many relationships allow flexible permission management
5. **Data Integrity**: Foreign keys ensure referential integrity across all tables
